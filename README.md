# Tinder-HighLoad

## Описание сервиса

### Сервис для знакомств

* 66 млн активных пользователей
* 1.6 млрд свайпов в день
* 12 млн совпадений в день
* Целевая аудитория находится в Северной Америке и Европе


### MVP
* Проофиль пользователя
* Лента рекомендаций
* Система лайков (matches)
* Чаты совместимых пользователей


## Расчет нагрузки

### Статистика

Примерное количество пользователей, находящихся в Северной Америке и Европе, составляет 50% от общего количества активных пользователей. Далее перевдены значения в соответсвии с этим распределнием.

|Значение|Параметр|
| :-------------:  | -------------  |
|80 млн|Количество зарегестрированных пользователей|
|33 млн |[ Количество активных пользователей в месяц](https://www.reuters.com/article/us-match-group-results-idUSKBN2A22V1)|
|12 млн (~37%)|[ Количество пользователей, пользующихся сервисом ежедневно](https://www.businessofapps.com/data/tinder-statistics/)|
|6 млн (~50%)|[ Количество пользователей в пиковое время (21:00)](https://www.huffingtonpost.co.uk/entry/how-to-get-tinder-matches_n_56a78f4be4b0172c659422da)|
|25 минут|[ Среднее время использования сервиса в день](https://ogury.com/perspectives/research-and-insights/dater-analysis-the-habits-of-dating-app-users-around-the-world/)|
|0.8 млрд|[ Количество свайпов в день](https://www.businessofapps.com/data/tinder-statistics/)|
|1.5 млрд |[Пиковое количество свайпов за день](https://www.bbc.com/news/business-52743454)|
|6 млн|[ Количество совпадений в день](https://www.businessofapps.com/data/tinder-statistics/)|
|9.92|[ Среднее количество просматриваемых страниц](https://www.similarweb.com/website/tinder.com/)|
|10 минут|[ Среднее время использования сервиса за 1 посещение](https://www.similarweb.com/website/tinder.com/)|

При 80 млн зарегистрированных пользователей предположим, что 30% пользователей когда-либо начинали общение в чате. В среднем на человека проиходится 5 чатов, по 10 сообщений.

	80 млн * 0.3 * 5 = 120 млн чатов
	
	120 млн * 10 = 1200 млн сообщений

Также предположим, что в среднем каждый пользователь сделал по 500 свайпов, при этом 10% из них превращались в мэтчи.

	80 млн * 500 = 40 млрд свайпов
	
	40 млрд * 0.1 = 4 млрд мэтчей


### Нагрузка

#### Общее RPS

При использовании сайта воспроизводилась прокрутка ленты и общение в чате.

###### Использование сайта 1 пользователем за 1 минуту:
	
	Статика - 1 МБ; 128 запросов
	
	Динамика - 650 КБ; 63 запроса
	
	Изображения - 4 МБ; 92 запроса

###### Использование сайта за 1 день:

При среднем времени использования сервиса в день равным 25 минутам и количеcтве пользователей, ежедневно пользующиеся сервисом, равным 12 млн:

	Статика - 1 МБ * 25 * 12e6 = 300e6 МБ; 128 * 25 * 12e6 = 38.4e9 запросов
	
	Динамика - 650 КБ * 25 * 12e6 = 192e6 МБ; 63 * 25 * 12e6 = 18.9e9 запросов
	
	Изображения - 4 МБ * 25 * 12e6 = 1200e6 МБ; 92 * 25 * 12e6 = 27.6e9 запросов

###### Трафик:

	Статика - 300e6 МБ / (24 * 60 * 60) ≈ 27 Гбит/с
	
	Динамика - 192e6 МБ / (24 * 60 * 60) ≈ 17 Гбит/с
	
	Изображения - 1200e6 МБ / (24 * 60 * 60) ≈ 109 Гбит/с
 
###### RPS:

	Статика 38.4e9 / (24 * 60 * 60) ≈ 444 000 RPS
	
	Динамика 18.9e9 / (24 * 60 * 60) ≈ 218 000 RPS
	
	Изображения 27.6e9 / (24 * 60 * 60) = 319 000 RPS


#### RPS по типам запросов

|Тип запроса|RPS|
| -------------  | :-------------:  |
|Проверка авторизации|74 000|
|Профиль пользователя|59 000|
|Свайпы и мэтчи|58 000|
|Чаты|27 000|


## Логическая схема БД

![](./media/db.png)

При прокрутки ленты свайпы сохраняются в таблицу swipes. Если находятся обоюдные свайпы с like=true, то данные о пользователях добавляются в таблицу matches. При этом мэтчи не исчезают с течением времени.

## Физическая схема БД

### Выбор СУБД

Данные пользователей, чаты и сообщения будем хранить в PostgreSQL, как в наиболее надежной и функциональной реляционной БД.

Данные сессии, свайпы и матчи будем хранить в Redis из-за его выскокой скорости работы. Также Redis поддерживает неблокирующую master-slave репликацию.

|Сущность|СУБД|
| -------------  | :-------------:  |
|Users|PostgresSQL|
|Sessions|Redis|
|Swipes|Redis|
|Matches|Redis|
|Messages|PostgresSQL|
|Chates|PostgresSQL|


### Шардирование и репликация

Данные пользователей, чаты будем шардировать по id. Сообщения будем шардировать по chat_id.

Фотографии будем шардировать по выдаваемому им id.

Для обеспечения отказоустойчивости используем master-slave репликацию.

### Размер данных

#### Фотографии

В среднем у пользователя в профиле находится 3 фотографии. Ограничим размер изображений 1МБ. Тогда примерный вес всех фотографий:

	80 млн * 3 * 1МБ = 240 млн МБ ≈ 245 Терабайта

#### Профили пользователей

Размер таблицы для 1 пользователя:

	8 + 64 + 15 + 64 + 512 + 1 + 1 + 8 + 8 + 8 + 128 + 64 + 128 + 128 + 64 + 64 = 1265 Б

Исходя из статистики в 80 млн зарегестрированных пользователей:

	1265 Б * 80e6 = 1012e8 Б ≈ 100 ГБ


#### Сессии пользователей

Размер таблицы для 1 сессии:

	8 + 8 + 64 + 8 = 88 Б

С учетом 33 млн активных пользователей:

	88 Б * 33e6 = 7040e6 Б ≈ 0.3 ГБ


#### Свайпы и мэтчи

Размер таблицы для 1 свайпа:

	8 + 8 + 8 + 1 = 25 Б

С учетом 40 млрд свайпов:

	25 Б * 40e9 = 1e12 Б ≈ 931 ГБ

Размер таблицы для 1 мэтча:

	8 + 8 + 8 = 24 Б

С учетом 4 млрд мэтчей:

	24 Б * 4e9 = 96e9 Б ≈ 89 ГБ


#### Чаты и сообщения пользователей

Размер таблицы для 1 чата:

	8 + 8 + 8 = 24 Б

С учетом 120 млн чатов:

	24 Б * 120e6 = 2880e6 Б ≈ 0.4 ГБ

Размер таблицы для 1 сообщения, принимая среднею длину сообщения равную 30 Б:

	8 + 8 + 8 + 30 + 8 + 8 = 70 Б

С учетом 1200 млн сообщений:

	70 Б * 1200e6 * 28 = 2352e9 Б ≈ 273 ГБ

#### Итоговая таблица

|Сущность|Размер (ГБ)|
| -------------  | :-------------:  |
|Сессии пользователей|0.3|
|Профиль пользователей|100|
|Свайпы и мэтчи|1020|
|Чаты|274|
|Фотографии|245 000|

### Оборудование

|Сущность|CPU (ядра)|RAM (Гб)|SSD (Гб)|Количество (masters+slaves)|
| -------------  | :-------------:  | :-------------:  | :-------------: | :-------------: |
|Сервисы авторизации|64|128|256|12 + 24|
|Сервис пользователя|64|128|256|10 + 20|
|Сервис свайпов и мэтчей|64|128|256|10 + 20|
|Сервис чатов|64|128|256|5 + 10|
|БД|32|128|256|9 + 18|
|Фотографии|64|128|2048|128 + 256|

#### Расположение серверов

Целевая аудитория находится в Северной Америке и Европе, поэтому расположим сервера в США и Германии.

## Выбор технологий

### Backend

Языком программирования выбран Golang. В качестве его преимуществ стоит выделить удобный менеджер зависимистей (go.mod), статическую типизацию, большое количество ранонаправленных библиотек, эффективную многопоточность (горутины). Микросервисная архитектура. В качестве протокола взимодействия выбран gRPC.

### Frontend

HTML, CSS/Sass, JS/Typescript с использованием фреймворка React. В качестве сборщика модулей - Webpack.

### Хостинг

В качестве хостинга выбран AWS.
